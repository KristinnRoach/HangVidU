name: Weekly dependency check
on:
  schedule:
    - cron: '0 6 * * 1' # every Monday 06:00 UTC
  workflow_dispatch:

jobs:
  pnpm-outdated:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
      - name: Install pnpm
        run: npm i -g pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Check outdated packages
        run: pnpm outdated --json > outdated.json || true
      - name: Create or update issue if outdated
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = (fs.existsSync('outdated.json') && fs.readFileSync('outdated.json','utf8').trim()) || '';
            if (!data || data === '[]') {
              core.info('No outdated deps');
              return;
            }
            const body = 'Automated report of outdated dependencies:\n\n```json\n' + data + '\n```\n\nConsider running `pnpm up` in a branch and opening a PR.';
            const { owner, repo } = context.repo;
            const open = await github.rest.issues.listForRepo({ owner, repo, state: 'open', labels: ['dependencies'] });
            const existing = open.data.find(i => i.title === 'Outdated dependencies report');
            if (existing) {
              await github.rest.issues.createComment({ owner, repo, issue_number: existing.number, body: '\n\n' + body });
            } else {
              await github.rest.issues.create({ owner, repo, title: 'Outdated dependencies report', body, labels: ['dependencies'] });
            }
