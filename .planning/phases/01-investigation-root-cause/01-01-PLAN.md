---
phase: 01-investigation-root-cause
plan: 1
type: execute
---

<objective>
Identify the exact cause of remote stream freezing when local user switches cameras during a call.

Purpose: Understand the root cause to inform Phase 2's fix implementation. This investigation will determine whether the issue is in track replacement, renegotiation, or ICE candidate handling.
Output: Clear understanding of failure point + reproducible test case + investigation findings document
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-investigation-root-cause/1-CONTEXT.md

**Codebase constraints:**
- Vanilla JavaScript ES6+ (no TypeScript)
- WebRTC peer connections managed through call-flow.js
- Firebase RTDB used for signaling (SDP offers/answers, ICE candidates)
- Event-driven architecture with CallController facade
- Function-based modules with cleanup lifecycle

**Prior context:**
This is the first phase - no prior decisions or deferred issues yet.

**Current understanding:**
- Switch camera button exists in UI but hidden via `display: none` (index.html:104-112)
- Full camera switching implementation exists in `src/media/media-devices.js`
- Feature disabled due to consistent remote stream freezing when switching cameras
- switchCamera() uses RTCRtpSender.replaceTrack() for track replacement (media-devices.js:85)

**Relevant source files:**
@index.html
@src/media/media-devices.js
@src/media/media-controls.js
@src/webrtc/call-flow.js
@src/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Uncomment and re-enable camera switch button</name>
  <files>index.html</files>
  <action>
    Remove the inline style `style="display: none"` from the switch camera button at index.html:106.
    Keep the `class="chat-btn hidden"` as-is - the "hidden" class will be removed by media-controls.js when hasFrontAndBackCameras() detects multiple cameras.
    Also remove or update the TODO comment at line 104 to indicate the button is now enabled for investigation purposes.
  </action>
  <verify>
    - Search index.html for "switch-camera-btn" - should NOT have `style="display: none"`
    - Button should still have `class="chat-btn hidden"` (visibility controlled by JS)
    - TODO comment removed or updated
  </verify>
  <done>Switch camera button is uncommented and will be shown/hidden based on device detection logic in media-controls.js</done>
</task>

<task type="auto">
  <name>Task 2: Trace camera switch code path and identify failure point</name>
  <files>src/media/media-devices.js, src/media/media-controls.js, src/webrtc/call-flow.js, .planning/phases/01-investigation-root-cause/INVESTIGATION-NOTES.md</files>
  <action>
    Read and analyze the complete camera switching flow:

    1. **Entry Point (media-controls.js:112-129):**
       - User clicks switch camera button
       - Calls switchCamera() with localStream, localVideo, currentFacingMode, peerConnection
       - Updates facingMode and localStream state on success

    2. **Track Replacement (media-devices.js:40-102):**
       - Gets new stream with flipped facingMode
       - Preserves video/audio enabled state
       - Stops old tracks
       - Calls replaceTrack() on peer connection senders (lines 81-91)
       - Updates local video srcObject

    3. **WebRTC Layer (call-flow.js):**
       - Check if there's any renegotiation logic after track replacement
       - Look for ICE candidate re-gathering
       - Verify if remote peer receives track updates

    **Key questions to answer:**
    - Does switchCamera() trigger SDP renegotiation? (replaceTrack() should NOT require renegotiation per WebRTC spec)
    - Are there event listeners for 'track' or 'negotiationneeded' events that might be missing?
    - Does the remote peer's RTCPeerConnection receive the new track automatically?
    - Is there any code that might stop/replace the remote stream incorrectly?

    Document findings in INVESTIGATION-NOTES.md with:
    - Complete code path trace
    - Identified gap or missing logic
    - Theory about why remote stream freezes
  </action>
  <verify>
    - INVESTIGATION-NOTES.md exists with complete code path documented
    - Theory documented about failure mechanism
    - Identified specific line(s) where issue likely occurs
  </verify>
  <done>Investigation notes document complete understanding of camera switch flow and contains clear theory about failure point</done>
</task>

<task type="auto">
  <name>Task 3: Create minimal reproduction test case</name>
  <files>tests/investigation/camera-switch-freeze.test.js</files>
  <action>
    Create a focused Vitest browser-mode test that reproduces the remote stream freeze:

    **Test structure:**
    1. Set up two RTCPeerConnections (simulating initiator and joiner)
    2. Establish connection with initial video tracks
    3. Simulate camera switch on initiator using replaceTrack()
    4. Verify joiner's remote stream continues to receive frames

    **What to test:**
    - Initial connection works (both peers see video tracks)
    - After replaceTrack() on sender, remote track events fire on receiver
    - Remote stream's video track is still active (readyState === 'live')
    - Remote video track continues to have frames (not frozen)

    Use fake media streams from Vitest browser provider. Keep test minimal - just enough to validate the theory from Task 2.

    **Expected outcome:**
    - Test should FAIL initially (reproducing the freeze bug)
    - Failure should confirm the theory from Task 2
    - This test will be used in Phase 2 to verify the fix works
  </action>
  <verify>
    - Test file exists at tests/investigation/camera-switch-freeze.test.js
    - Run: pnpm test camera-switch-freeze
    - Test should fail with expected failure (remote stream freeze reproduced)
  </verify>
  <done>Test reproduces the freeze bug and confirms the failure mechanism identified in Task 2</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Switch camera button uncommented in index.html
- [ ] INVESTIGATION-NOTES.md documents complete code path and theory
- [ ] Test case exists and reproduces the freeze bug
- [ ] Theory about failure mechanism is clearly documented
</verification>

<success_criteria>
- All tasks completed
- Camera switch button is accessible for testing
- Root cause theory documented with supporting code analysis
- Reproducible test case exists that demonstrates the bug
- Clear understanding of what needs to be fixed in Phase 2
</success_criteria>

<output>
After completion, create `.planning/phases/01-investigation-root-cause/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Investigation & Root Cause Analysis Summary

**[One-liner summary of findings]**

## Accomplishments

- Uncommented switch camera button for investigation
- Traced complete camera switching code path
- Identified root cause of remote stream freezing
- Created reproducible test case

## Files Created/Modified

- `index.html` - Uncommented switch camera button
- `.planning/phases/01-investigation-root-cause/INVESTIGATION-NOTES.md` - Investigation findings
- `tests/investigation/camera-switch-freeze.test.js` - Reproduction test case

## Decisions Made

[Root cause identified - specific mechanism documented in INVESTIGATION-NOTES.md]

## Issues Encountered

[Any surprises during investigation, or "None"]

## Next Phase Readiness

Phase 2 can proceed with:
- Clear understanding of failure mechanism
- Test case to verify fix works
- Button re-enabled for manual testing
</output>
