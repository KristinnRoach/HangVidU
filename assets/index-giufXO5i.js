(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const W=document.getElementById("localVideo"),w=document.getElementById("remoteVideo"),r=document.getElementById("sharedVideo"),C=document.getElementById("startChat"),S=document.getElementById("hangUp"),B=document.getElementById("copyLink"),E=document.getElementById("pipBtn"),M=document.getElementById("switchCameraBtn"),T=document.getElementById("toggleMute"),x=document.getElementById("toggleVideo"),k=document.getElementById("toggleMode"),se=document.getElementById("loadStream"),le=document.getElementById("status"),G=document.getElementById("linkContainer"),q=document.getElementById("watchContainer"),z=document.querySelector(".video-container"),s=document.getElementById("syncStatus"),I=document.getElementById("shareLink"),v=document.getElementById("streamUrl"),de={apiKey:"AIzaSyA-fvCaKCjyEFX__YAVr1oPGdVsUEhFehA",authDomain:"vidu-aae11.firebaseapp.com",databaseURL:"https://vidu-aae11-default-rtdb.europe-west1.firebasedatabase.app",projectId:"vidu-aae11",storageBucket:"vidu-aae11.firebasestorage.app",messagingSenderId:"765724787439",appId:"1:765724787439:web:61a3b5dd538149564c911a",measurementId:"G-EGJ53HLGY4"};firebase.initializeApp(de);const y=firebase.database();async function ue(e,t){const n=y.ref(`rooms/${e}`);return await n.set({offer:{type:t.type,sdp:t.sdp}}),n}async function me(e){const t=y.ref(`rooms/${e}`),n=await t.once("value");return{roomRef:t,roomSnapshot:n}}async function fe(e){await y.ref(`rooms/${e}`).remove()}function ye(e,t){e.textContent=t}function pe(e,t,n){const i=e.getAudioTracks()[0];return i&&(n=!n,i.enabled=!n,t.textContent=n?"Unmute Mic":"Mute Mic"),n}function ge(e,t,n){const i=e.getVideoTracks()[0];return i&&(n=!n,i.enabled=n,t.textContent=n?"Turn Video Off":"Turn Video On"),n}function Pe(e,t,n,i,o,a,d){return e=!e,e?(t.style.display="none",n.style.display="block",i.textContent="Switch to Video Chat",d.textContent="Paste the same stream URL as your partner"):(t.style.display="flex",n.style.display="none",i.textContent="Switch to Watch Mode",o.src="",a.value=""),e}function ve({startChatBtn:e,hangUpBtn:t,copyLinkBtn:n,switchCameraBtn:i,toggleMuteBtn:o,toggleVideoBtn:a,toggleModeBtn:d,loadStreamBtn:m,pipBtn:h,remoteVideo:P,handleStartChat:R,handleHangUp:te,handleCopyLink:ne,handleToggleMute:oe,handleToggleVideo:ie,handleToggleMode:ae,handleLoadStream:re,handlePipToggle:N,handleSwitchCamera:ce,updateStatus:$e}){document.addEventListener("keydown",D=>{D.altKey&&D.key==="p"&&P.srcObject&&(D.preventDefault(),N())}),e.addEventListener("click",R),t.addEventListener("click",te),n.addEventListener("click",ne),i.addEventListener("click",ce),o.addEventListener("click",oe),a.addEventListener("click",ie),d.addEventListener("click",ae),m.addEventListener("click",re),h.addEventListener("click",N)}let c=null,b=!1,he=()=>!!document.pictureInPictureElement;async function we(e,t,n,i=!1){console.log("[PiP] Toggle requested",{hasDocumentPiP:"documentPictureInPicture"in window,hasStream:!!e.srcObject,hasFloatingWindow:!!document.pictureInPictureElement,documentPipWindowOpen:!!c,nativePipActive:he()});try{if(!e.srcObject){console.warn("[PiP] No remote stream available"),n("Connect to a partner first");return}if(document.pictureInPictureElement){console.log("[PiP] Exiting active native PiP (via custom button)"),await document.exitPictureInPicture(),b=!1,t.textContent="Float Partner Video";return}if(c){console.log("[PiP] Closing existing Document PiP window"),c.close(),c=null,t.textContent="Float Partner Video";return}if(e.offsetParent===null&&!("documentPictureInPicture"in window)){console.warn("[PiP] Video is hidden and Document PiP not available"),n("Switch to Video Chat mode to use floating window");return}if(i&&"documentPictureInPicture"in window){await be(e,t);return}if("pictureInPictureEnabled"in document){await Ce(e,t);return}}catch(o){console.error("[PiP] Error:",o.name,o.message,o),o.name==="NotAllowedError"?n("Picture-in-Picture blocked. Check browser permissions."):o.name==="InvalidStateError"?n("Cannot open PiP - video not ready"):n("Picture-in-Picture failed. See console for details.")}}async function be(e,t){console.log("[PiP] Opening Document PiP window");try{if(c=await window.documentPictureInPicture.requestWindow({width:400,height:300}),console.log("[PiP] Document PiP window created",{width:c.innerWidth,height:c.innerHeight,closed:c.closed}),c.closed)throw console.error("[PiP] Window was closed immediately after creation"),c=null,new Error("PiP window closed immediately");[...document.styleSheets].forEach(m=>{try{const h=[...m.cssRules].map(R=>R.cssText).join(""),P=document.createElement("style");P.textContent=h,c.document.head.appendChild(P)}catch{const P=document.createElement("link");P.rel="stylesheet",P.href=m.href,c.document.head.appendChild(P)}}),c.document.body.innerHTML=`
    <div style="display: flex; flex-direction: column; height: 100vh; background: #1a1a1a;">
      <video id="pipVideo" autoplay muted playsinline style="flex: 1; width: 100%; background: #000;"></video>
      <button id="pipMute" style="padding: 10px; background: #ff9800; color: white; border: none; cursor: pointer; font-size: 14px;">
        Unmute Partner
      </button>
    </div>
  `;const n=c.document.getElementById("pipVideo"),i=c.document.getElementById("pipMute"),o=e.srcObject.getVideoTracks(),a=e.srcObject.getAudioTracks();console.log("[PiP] Stream tracks:",{video:o.length,audio:a.length,videoActive:o[0]?.enabled,audioActive:a[0]?.enabled}),n.srcObject=e.srcObject,console.log("[PiP] Stream attached to PiP video"),console.log("[PiP] Video will autoplay (muted initially for browser policy)");let d=!0;i.addEventListener("click",()=>{if(!e.srcObject){console.warn("[PiP] Remote stream no longer available");return}d=!d,n.muted=d,d?e.muted=!1:e.muted=!0,i.textContent=d?"Unmute Partner":"Mute Partner",i.style.background=d?"#ff9800":"#4caf50",console.log("[PiP] Partner audio in PiP window:",d?"MUTED":"UNMUTED")}),c.addEventListener("pagehide",()=>{console.log("[PiP] Document PiP window closed by user or browser"),c=null,t.textContent="Float Partner Video"}),c.addEventListener("load",()=>{console.log("[PiP] Document PiP window loaded event fired")}),n.addEventListener("error",m=>{console.error("[PiP] Video element error:",m)}),n.addEventListener("loadedmetadata",()=>{console.log("[PiP] Video metadata loaded in PiP window")}),t.textContent="Close Float Window",console.log("[PiP] Document PiP setup complete")}catch(n){throw console.error("[PiP] Error during Document PiP setup:",n),c&&(c.close(),c=null),n}}async function Ce(e,t){document.pictureInPictureElement?(console.log("[PiP] Exiting native PiP"),await document.exitPictureInPicture(),b=!1,t.textContent="Float Partner Video"):(console.log("[PiP] Entering native PiP"),await e.requestPictureInPicture(),b=!0,t.textContent="Exit Float Mode")}function Ee(e,t){e.addEventListener("enterpictureinpicture",()=>{console.log("[PiP] Remote video entered native PiP (via browser controls)"),b=!0,t.textContent="Exit Float Mode"}),e.addEventListener("leavepictureinpicture",()=>{console.log("[PiP] Remote video exited native PiP (via browser controls)"),b=!1,t.textContent="Float Partner Video"})}function ke(e){console.log("[PiP] Cleanup requested"),c&&(console.log("[PiP] Closing Document PiP window during cleanup"),c.close(),c=null),b&&document.pictureInPictureElement&&(console.log("[PiP] Exiting native PiP during cleanup"),document.exitPictureInPicture().catch(t=>{console.warn("[PiP] Failed to exit native PiP:",t)}),b=!1),e&&(e.textContent="Float Partner Video",e.style.display="none"),console.log("[PiP] Cleanup complete")}let $=null,A=!1;function L(e){return/(?:youtu.be\/|youtube.com\/(?:watch\?v=|embed\/|v\/))([\w-]{11})/.test(e)}function K(e){const t=e.match(/(?:youtu.be\/|youtube.com\/(?:watch\?v=|embed\/|v\/))([\w-]{11})/);return t?t[1]:null}function _(e,t,n){t.style.display="none";const i=document.getElementById("yt-iframe");i&&i.remove();let o=document.getElementById("yt-player-div");o||(o=document.createElement("div"),o.id="yt-player-div",t.parentNode.insertBefore(o,t)),o.innerHTML='<div id="yt-iframe"></div>',o.style.display="",$=new YT.Player("yt-iframe",{height:"360",width:"640",videoId:e,events:{onReady:()=>{A=!0},onStateChange:n}})}function J(e){const t=document.getElementById("yt-player-div");t&&(t.style.display="none"),e.style.display="",$=null,A=!1}function V(){return $}function O(){return A}function Te(){return!!(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)}async function xe(){return Te()?(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="videoinput"):[]}async function Ie(){const e=await xe();let t=!1,n=!1;return e.forEach(i=>{const o=i.label.toLowerCase();o.includes("front")&&(t=!0),(o.includes("back")||o.includes("rear")||o.includes("environment"))&&(n=!0)}),t&&n}async function Le({localStream:e,currentFacingMode:t,localVideo:n,peerConnection:i}){const o=t==="user"?"environment":"user";e.getVideoTracks().forEach(m=>m.stop());const d=(await navigator.mediaDevices.getUserMedia({video:{facingMode:o},audio:!0})).getVideoTracks()[0];if(e.removeTrack(e.getVideoTracks()[0]),e.addTrack(d),n.srcObject=e,i){const m=i.getSenders().find(h=>h.track&&h.track.kind==="video");m&&m.replaceTrack(d)}return o}const X={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};let g,u,l=null,U=!1,F=!1,j=!0,H="user",Y=!1,f=!1;async function Se(){try{g=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),W.srcObject=g,T.style.display="block",x.style.display="block",await Ie()?M.style.display="block":M.style.display="none",ve({startChatBtn:C,hangUpBtn:S,copyLinkBtn:B,switchCameraBtn:M,toggleMuteBtn:T,toggleVideoBtn:x,toggleModeBtn:k,loadStreamBtn:se,pipBtn:E,remoteVideo:w,handleStartChat:Re,handleHangUp:Me,handleCopyLink:Ve,handleSwitchCamera:async()=>{H=await Le({localStream:g,currentFacingMode:H,localVideo:W,peerConnection:u})},handleToggleMute:Oe,handleToggleVideo:Ue,handleToggleMode:Fe,handleLoadStream:je,handlePipToggle:()=>we(w,E,p),updateStatus:p}),l=new URLSearchParams(window.location.search).get("room"),l?(p("Connecting..."),C.style.display="none",await De(l)):p("Ready. Click to generate video chat link.")}catch(e){console.error("Media error:",e),p("Error: Could not access camera/mic. Check permissions.")}}function Q(e){w.srcObject=e.streams[0],E.style.display="block",Ee(w,E),p("Connected!")}async function Re(){U=!0,l=Be(),u=new RTCPeerConnection(X),g.getTracks().forEach(i=>{u.addTrack(i,g)});const e=await u.createOffer();await u.setLocalDescription(e);const t=await ue(l,e);u.ontrack=Q,u.onicecandidate=i=>{i.candidate&&t.child("callerCandidates").push(i.candidate.toJSON())},t.child("answer").on("value",async i=>{const o=i.val();o&&!u.currentRemoteDescription&&await u.setRemoteDescription(new RTCSessionDescription(o))}),t.child("calleeCandidates").on("child_added",i=>{const o=i.val();u.addIceCandidate(new RTCIceCandidate(o))});const n=`${window.location.origin}${window.location.pathname}?room=${l}`;I.value=n,G.style.display="block",C.disabled=!0,S.disabled=!1,ee(),k.style.display="block",p("Link ready! Waiting for partner...")}async function De(e){const{roomRef:t,roomSnapshot:n}=await me(e);if(!n.exists()){p("Error: Invalid room link");return}u=new RTCPeerConnection(X),g.getTracks().forEach(a=>{u.addTrack(a,g)}),u.ontrack=Q,u.onicecandidate=a=>{a.candidate&&t.child("calleeCandidates").push(a.candidate.toJSON())};const i=n.val().offer;await u.setRemoteDescription(new RTCSessionDescription(i));const o=await u.createAnswer();await u.setLocalDescription(o),await t.child("answer").set({type:o.type,sdp:o.sdp}),t.child("callerCandidates").on("child_added",a=>{const d=a.val();u.addIceCandidate(new RTCIceCandidate(d))}),ee(),k.style.display="block",S.disabled=!1}async function Me(){ke(E),u&&(u.close(),u=null),w.srcObject&&(w.srcObject.getTracks().forEach(e=>e.stop()),w.srcObject=null),l&&U&&await fe(l),l=null,U=!1,C.disabled=!1,C.style.display="block",S.disabled=!0,G.style.display="none",T.style.display="none",x.style.display="none",k.style.display="none",q.style.display="none",z.style.display="flex",I.value="",r.src="",v.value="",s.textContent="",Y=!1,F=!1,j=!0,window.history.replaceState({},document.title,window.location.pathname),p("Disconnected. Ready for new chat.")}function Be(){return Math.random().toString(36).substring(2,15)}async function Ve(){try{await navigator.clipboard.writeText(I.value),B.textContent="Copied!",setTimeout(()=>B.textContent="Copy Link",2e3)}catch{I.select(),document.execCommand("copy")}}function p(e){ye(le,e)}function Oe(){F=pe(g,T,F)}function Ue(){j=ge(g,x,j)}function Fe(){Y=Pe(Y,z,q,k,r,v,s)}function je(){const e=v.value.trim();if(!e){s.textContent="Please enter a stream URL";return}if(L(e)){const t=K(e);_(t,r,Z),s.textContent="YouTube video sent to partner..."}else J(r),r.src=e,s.textContent="Video sent to partner...";l&&y.ref(`rooms/${l}/stream`).set({url:e})}function Z(e){const t=V(),n=O();!l||!n||!t||(e.data===YT.PlayerState.PLAYING?y.ref(`rooms/${l}/stream`).update({playing:!0,time:t.getCurrentTime()}):e.data===YT.PlayerState.PAUSED&&y.ref(`rooms/${l}/stream`).update({playing:!1,time:t.getCurrentTime()}))}function Ye(){const e=v.value;if(L(e)){const t=K(e);_(t,r,Z),s.textContent="Loading YouTube video..."}else J(r),r.src=e,s.textContent="Loading shared video...";s.style.background="#2a2a2a"}function ee(){if(!l)return;const e=y.ref(`rooms/${l}`);e.child("stream/url").on("value",t=>{const n=t.val();n&&n!==v.value&&(v.value=n,s.innerHTML='Partner shared a video: <button id="accept-shared-video" style="margin-left: 10px; padding: 5px 15px;">✓ Accept & Load</button>',document.getElementById("accept-shared-video").addEventListener("click",Ye),s.style.background="#2196f3")}),e.child("stream/playing").on("value",async t=>{if(f)return;const n=t.val(),i=v.value,o=V(),a=O();if(L(i)&&o&&a)n===!0&&o.getPlayerState()!==YT.PlayerState.PLAYING?(o.playVideo(),s.textContent="Playing in sync"):n===!1&&o.getPlayerState()===YT.PlayerState.PLAYING&&(o.pauseVideo(),s.textContent="Partner pressed pause");else if(n===!0&&r.paused)try{await r.play(),s.textContent="Playing in sync"}catch{s.textContent="▶️ Tap the video to start playing",s.style.background="#FF5722",s.style.fontSize="16px";const m=()=>{s.style.background="#2a2a2a",s.style.fontSize="14px",r.removeEventListener("play",m)};r.addEventListener("play",m)}else n===!1&&!r.paused&&(r.pause(),s.textContent="Partner pressed pause")}),e.child("stream/time").on("value",t=>{if(f)return;const n=t.val(),i=v.value,o=V(),a=O();L(i)&&o&&a?n!==null&&Math.abs(o.getCurrentTime()-n)>2&&(o.seekTo(n,!0),s.textContent=`Syncing to ${Math.floor(n)}s`):n!==null&&Math.abs(r.currentTime-n)>2&&(r.currentTime=n,s.textContent=`Syncing to ${Math.floor(n)}s`)}),r.addEventListener("play",()=>{l&&!f&&(f=!0,y.ref(`rooms/${l}/stream`).update({playing:!0,time:r.currentTime}),setTimeout(()=>f=!1,1e3))}),r.addEventListener("pause",()=>{l&&!f&&(f=!0,y.ref(`rooms/${l}/stream`).update({playing:!1,time:r.currentTime}),setTimeout(()=>f=!1,1e3))}),r.addEventListener("seeked",()=>{l&&!f&&(f=!0,y.ref(`rooms/${l}/stream`).update({time:r.currentTime}),setTimeout(()=>f=!1,1e3))}),r.addEventListener("loadeddata",()=>{s.textContent="Video loaded! Press play to start."}),r.addEventListener("waiting",()=>{s.textContent="Buffering..."}),r.addEventListener("playing",()=>{s.textContent="Playing in sync"})}Se();
