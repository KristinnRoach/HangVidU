(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const v=document.getElementById("localVideo"),l=document.getElementById("remoteVideo"),d=document.getElementById("sharedVideo"),S=document.getElementById("startChat"),U=document.getElementById("hangUp"),H=document.getElementById("copyLink"),x=document.getElementById("pipBtn"),_=document.getElementById("switchCameraBtn"),N=document.getElementById("toggleMute"),F=document.getElementById("toggleVideo"),B=document.getElementById("toggleMode"),be=document.getElementById("loadStream"),Ee=document.getElementById("status"),ae=document.getElementById("linkContainer"),re=document.getElementById("watchContainer"),ce=document.querySelector(".video-container"),f=document.getElementById("syncStatus"),M=document.getElementById("shareLink"),P=document.getElementById("streamUrl"),oe=document.getElementById("mutePartnerBtn"),ke=document.getElementById("fullscreenPartnerBtn"),ie=document.getElementById("muteSelfBtn"),Te=document.getElementById("fullscreenSelfBtn"),X="hangvidu_session",Re=1440*60*1e3;function Ie(e){const t={...e,timestamp:Date.now()};localStorage.setItem(X,JSON.stringify(t))}function Se(){const e=localStorage.getItem(X);if(!e)return null;try{const t=JSON.parse(e);return Date.now()-t.timestamp>Re?(J(),null):t}catch(t){return console.error("Failed to parse stored state:",t),J(),null}}function J(){localStorage.removeItem(X)}const De={apiKey:"AIzaSyA-fvCaKCjyEFX__YAVr1oPGdVsUEhFehA",authDomain:"vidu-aae11.firebaseapp.com",databaseURL:"https://vidu-aae11-default-rtdb.europe-west1.firebasedatabase.app",projectId:"vidu-aae11",storageBucket:"vidu-aae11.firebasestorage.app",messagingSenderId:"765724787439",appId:"1:765724787439:web:61a3b5dd538149564c911a",measurementId:"G-EGJ53HLGY4"};if(typeof firebase>"u")throw new Error("[firebase.js] Global firebase object is not defined! Make sure the Firebase CDN scripts are loaded before your app code runs.");firebase.apps.length||firebase.initializeApp(De);const g=firebase.database();function O(e,t,n){if(!e||!t)return;const i=`rooms/${e}/connections/${t}`;return g.ref(i).set({status:n,timestamp:Date.now()})}function Q(e,t,n){if(!e||!t)return null;const o=`rooms/${e}/connections/${t==="initiator"?"joiner":"initiator"}/status`,r=g.ref(o),s=m=>{m.val()==="reconnecting"&&n()};return r.on("value",s),()=>r.off("value",s)}async function Le(e,t){const n=g.ref(`rooms/${e}`);return await n.set({offer:{type:t.type,sdp:t.sdp}}),n}async function xe(e){const t=g.ref(`rooms/${e}`),n=await t.once("value");return{roomRef:t,roomSnapshot:n}}async function Be(e){console.log("[ROOM-DEBUG] removeRoom called for roomId:",e,"at",new Date().toISOString()),await g.ref(`rooms/${e}`).remove()}function Oe(e,t){e.textContent=t}function Ne(e,t,n){const i=e.getAudioTracks()[0];return i&&(n=!n,i.enabled=!n,t.textContent=n?"Unmute Mic":"Mute Mic"),n}function Fe(e,t,n){const i=e.getVideoTracks()[0];return i&&(n=!n,i.enabled=n,t.textContent=n?"Turn Video Off":"Turn Video On"),n}function Me(e,t,n,i,o,r,s){return e=!e,e?(t.style.display="none",n.style.display="block",i.textContent="Switch to Video Chat",s.textContent="Paste the same stream URL as your partner"):(t.style.display="flex",n.style.display="none",i.textContent="Switch to Watch Mode",o.src="",r.value=""),e}function Ve({startChatBtn:e,hangUpBtn:t,copyLinkBtn:n,switchCameraBtn:i,toggleMuteBtn:o,toggleVideoBtn:r,toggleModeBtn:s,loadStreamBtn:m,pipBtn:C,remoteVideo:b,handleStartChat:$,handleHangUp:pe,handleCopyLink:ye,handleToggleMute:we,handleToggleVideo:Pe,handleToggleMode:he,handleLoadStream:ve,handlePipToggle:ne,handleSwitchCamera:Ce,updateStatus:it}){document.addEventListener("keydown",G=>{G.altKey&&G.key==="p"&&b.srcObject&&(G.preventDefault(),ne())}),e.addEventListener("click",$),t.addEventListener("click",pe),n.addEventListener("click",ye),i.addEventListener("click",Ce),o.addEventListener("click",we),r.addEventListener("click",Pe),s.addEventListener("click",he),m.addEventListener("click",ve),C.addEventListener("click",ne)}let u=null,I=!1,Ue=()=>!!document.pictureInPictureElement;async function je(e,t,n,i=!1){console.log("[PiP] Toggle requested",{hasDocumentPiP:"documentPictureInPicture"in window,hasStream:!!e.srcObject,hasFloatingWindow:!!document.pictureInPictureElement,documentPipWindowOpen:!!u,nativePipActive:Ue()});try{if(!e.srcObject){console.warn("[PiP] No remote stream available"),n("Connect to a partner first");return}if(document.pictureInPictureElement){console.log("[PiP] Exiting active native PiP (via custom button)"),await document.exitPictureInPicture(),I=!1,t.textContent="Float Partner Video";return}if(u){console.log("[PiP] Closing existing Document PiP window"),u.close(),u=null,t.textContent="Float Partner Video";return}if(e.offsetParent===null&&!("documentPictureInPicture"in window)){console.warn("[PiP] Video is hidden and Document PiP not available"),n("Switch to Video Chat mode to use floating window");return}if(i&&"documentPictureInPicture"in window){await Ae(e,t);return}if("pictureInPictureEnabled"in document){await $e(e,t);return}}catch(o){console.error("[PiP] Error:",o.name,o.message,o),o.name==="NotAllowedError"?n("Picture-in-Picture blocked. Check browser permissions."):o.name==="InvalidStateError"?n("Cannot open PiP - video not ready"):n("Picture-in-Picture failed. See console for details.")}}async function Ae(e,t){console.log("[PiP] Opening Document PiP window");try{if(u=await window.documentPictureInPicture.requestWindow({width:400,height:300}),console.log("[PiP] Document PiP window created",{width:u.innerWidth,height:u.innerHeight,closed:u.closed}),u.closed)throw console.error("[PiP] Window was closed immediately after creation"),u=null,new Error("PiP window closed immediately");[...document.styleSheets].forEach(m=>{try{const C=[...m.cssRules].map($=>$.cssText).join(""),b=document.createElement("style");b.textContent=C,u.document.head.appendChild(b)}catch{const b=document.createElement("link");b.rel="stylesheet",b.href=m.href,u.document.head.appendChild(b)}}),u.document.body.innerHTML=`
    <div style="display: flex; flex-direction: column; height: 100vh; background: #1a1a1a;">
      <video id="pipVideo" autoplay muted playsinline style="flex: 1; width: 100%; background: #000;"></video>
      <button id="pipMute" style="padding: 10px; background: #ff9800; color: white; border: none; cursor: pointer; font-size: 14px;">
        Unmute Partner
      </button>
    </div>
  `;const n=u.document.getElementById("pipVideo"),i=u.document.getElementById("pipMute"),o=e.srcObject.getVideoTracks(),r=e.srcObject.getAudioTracks();console.log("[PiP] Stream tracks:",{video:o.length,audio:r.length,videoActive:o[0]?.enabled,audioActive:r[0]?.enabled}),n.srcObject=e.srcObject,console.log("[PiP] Stream attached to PiP video"),console.log("[PiP] Video will autoplay (muted initially for browser policy)");let s=!0;i.addEventListener("click",()=>{if(!e.srcObject){console.warn("[PiP] Remote stream no longer available");return}s=!s,n.muted=s,s?e.muted=!1:e.muted=!0,i.textContent=s?"Unmute Partner":"Mute Partner",i.style.background=s?"#ff9800":"#4caf50",console.log("[PiP] Partner audio in PiP window:",s?"MUTED":"UNMUTED")}),u.addEventListener("pagehide",()=>{console.log("[PiP] Document PiP window closed by user or browser"),u=null,t.textContent="Float Partner Video"}),u.addEventListener("load",()=>{console.log("[PiP] Document PiP window loaded event fired")}),n.addEventListener("error",m=>{console.error("[PiP] Video element error:",m)}),n.addEventListener("loadedmetadata",()=>{console.log("[PiP] Video metadata loaded in PiP window")}),t.textContent="Close Float Window",console.log("[PiP] Document PiP setup complete")}catch(n){throw console.error("[PiP] Error during Document PiP setup:",n),u&&(u.close(),u=null),n}}async function $e(e,t){document.pictureInPictureElement?(console.log("[PiP] Exiting native PiP"),await document.exitPictureInPicture(),I=!1,t.textContent="Float Partner Video"):(console.log("[PiP] Entering native PiP"),await e.requestPictureInPicture(),I=!0,t.textContent="Exit Float Mode")}function Ge(e,t){e.addEventListener("enterpictureinpicture",()=>{console.log("[PiP] Remote video entered native PiP (via browser controls)"),I=!0,t.textContent="Exit Float Mode"}),e.addEventListener("leavepictureinpicture",()=>{console.log("[PiP] Remote video exited native PiP (via browser controls)"),I=!1,t.textContent="Float Partner Video"})}function _e(e){console.log("[PiP] Cleanup requested"),u&&(console.log("[PiP] Closing Document PiP window during cleanup"),u.close(),u=null),I&&document.pictureInPictureElement&&(console.log("[PiP] Exiting native PiP during cleanup"),document.exitPictureInPicture().catch(t=>{console.warn("[PiP] Failed to exit native PiP:",t)}),I=!1),e&&(e.textContent="Float Partner Video",e.style.display="none"),console.log("[PiP] Cleanup complete")}let Z=null,ee=!1;function V(e){return/(?:youtu.be\/|youtube.com\/(?:watch\?v=|embed\/|v\/))([\w-]{11})/.test(e)}function se(e){const t=e.match(/(?:youtu.be\/|youtube.com\/(?:watch\?v=|embed\/|v\/))([\w-]{11})/);return t?t[1]:null}function le(e,t,n){t.style.display="none";const i=document.getElementById("yt-iframe");i&&i.remove();let o=document.getElementById("yt-player-div");o||(o=document.createElement("div"),o.id="yt-player-div",t.parentNode.insertBefore(o,t)),o.innerHTML='<div id="yt-iframe"></div>',o.style.display="",Z=new YT.Player("yt-iframe",{height:"360",width:"640",videoId:e,events:{onReady:()=>{ee=!0},onStateChange:n}})}function de(e){const t=document.getElementById("yt-player-div");t&&(t.style.display="none"),e.style.display="",Z=null,ee=!1}function z(){return Z}function K(){return ee}function qe(){return!!(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)}async function Ye(){return qe()?(await navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="videoinput"):[]}async function We(){const e=await Ye();let t=!1,n=!1;return e.forEach(i=>{const o=i.label.toLowerCase();o.includes("front")&&(t=!0),(o.includes("back")||o.includes("rear")||o.includes("environment"))&&(n=!0)}),t&&n}async function He({localStream:e,currentFacingMode:t,localVideo:n,peerConnection:i}){const o=t==="user"?"environment":"user";e.getVideoTracks().forEach(m=>m.stop());const s=(await navigator.mediaDevices.getUserMedia({video:{facingMode:o},audio:!0})).getVideoTracks()[0];if(e.removeTrack(e.getVideoTracks()[0]),e.addTrack(s),n.srcObject=e,i){const m=i.getSenders().find(C=>C.track&&C.track.kind==="video");m&&m.replaceTrack(s)}return o}function Je({urlRoomId:e,savedState:t}){const n=e||t?.roomId;if(!n)return{action:"idle"};const i=t?.roomId===n,o=t?.wasConnected===!0;return i&&o?{action:"reconnect",roomId:n}:{action:"join",roomId:n}}const j={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};let y,a,c=null,D=!1,h=!1,E=!1,k=!0,L="user",T=!1,w=!1;function R(){Ie({roomId:c,isInitiator:h,isAudioMuted:E,isVideoOn:k,currentFacingMode:L,watchMode:T,wasConnected:D,streamUrl:P.value})}async function ze(){console.log("🚀 init() called");try{y=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),v.srcObject=y,N.style.display="block",F.style.display="block",await We()?_.style.display="block":_.style.display="none",Ve({startChatBtn:S,hangUpBtn:U,copyLinkBtn:H,switchCameraBtn:_,toggleMuteBtn:N,toggleVideoBtn:F,toggleModeBtn:B,loadStreamBtn:be,pipBtn:x,remoteVideo:l,handleStartChat:Xe,handleHangUp:Ze,handleCopyLink:tt,handleSwitchCamera:async()=>{L=await He({localStream:y,currentFacingMode:L,localVideo:v,peerConnection:a}),R()},handleToggleMute:q,handleToggleVideo:Y,handleToggleMode:W,handleLoadStream:nt,handlePipToggle:()=>je(l,x,p),updateStatus:p});const t=new URLSearchParams(window.location.search).get("room"),n=Se();console.log("📦 savedState:",n);const i=Je({urlRoomId:t,savedState:n});c=i.roomId,i.action==="reconnect"?(p("Connecting..."),S.style.display="none",n&&(E=n.isAudioMuted,k=n.isVideoOn,L=n.currentFacingMode,h=n.isInitiator,T=n.watchMode||!1,D=n.wasConnected||!1,k||Y(),E&&q()),console.log("🔄 Calling handleReconnection"),await Ke(),n?.watchMode&&!T&&(W(),n.streamUrl&&(P.value=n.streamUrl))):i.action==="join"?(p("Connecting..."),S.style.display="none",n&&(E=n.isAudioMuted,k=n.isVideoOn,L=n.currentFacingMode,h=n.isInitiator,T=n.watchMode||!1,D=n.wasConnected||!1,k||Y(),E&&q()),console.log("🆕 Calling joinChatRoom"),await Qe(c),n?.watchMode&&!T&&(W(),n.streamUrl&&(P.value=n.streamUrl))):p("Ready. Click to generate video chat link.")}catch(e){let t="Error: Could not access camera/mic.";e.name==="NotAllowedError"?t+=" Permission denied. Please allow access to your camera and microphone.":e.name==="NotFoundError"||e.name==="DevicesNotFoundError"?t+=" No camera or microphone found on this device.":e.name==="NotReadableError"||e.name==="TrackStartError"?t+=" Camera or microphone is already in use by another application.":e.name==="OverconstrainedError"||e.name==="ConstraintNotSatisfiedError"?t+=" The requested media device is not available or does not support the requested constraints.":e.name==="NotSupportedError"?t+=" Your browser or device does not support video/audio capture, or HTTPS is required.":t+=" "+e.message,console.error("Media error:",t,e),p(t)}}function A(e){if(l.srcObject!==e.streams[0]){l.srcObject=e.streams[0],x.style.display="block",Ge(l,x),D=!0,console.log("✅ Connection established, wasConnected =",D),R(),p("Connected!"),window.__remoteVideoDebugCount?window.__remoteVideoDebugCount++:window.__remoteVideoDebugCount=1;const t=window.__remoteVideoDebugCount;console.log(`[DEBUG][Connected!][#${t}] remoteVideo:`,{srcObject:l.srcObject,videoTracks:l.srcObject?.getVideoTracks?.()||null,readyState:l.readyState,videoWidth:l.videoWidth,videoHeight:l.videoHeight,currentTime:l.currentTime,paused:l.paused,ended:l.ended,display:l.style.display,event:e,stack:new Error().stack}),l.paused&&l.srcObject&&l.play().catch(n=>{console.warn("[DEBUG][Connected!][#"+t+"] remoteVideo.play() failed:",n)})}else{window.__remoteVideoDebugCount?window.__remoteVideoDebugCount++:window.__remoteVideoDebugCount=1;const t=window.__remoteVideoDebugCount;console.log(`[DEBUG][Connected!][#${t}] Duplicate ontrack event ignored. remoteVideo.srcObject already set to this stream.`,{srcObject:l.srcObject,event:e,stack:new Error().stack})}}async function te(){if(p("Partner reconnecting..."),fe(),a&&(a.close(),a=null),l.srcObject&&(l.srcObject=null),h)await ue();else{p("Waiting for partner to reconnect...");const e=g.ref(`rooms/${c}`);e.child("offer").once("value",async t=>{const n=t.val();if(console.log("[RECONN-DEBUG] Joiner received offer snapshot:",n),!n)return;a=new RTCPeerConnection(j),y.getTracks().forEach(r=>{a.addTrack(r,y)}),console.log("[DEBUG] Assigning peerConnection.ontrack in handlePartnerReconnecting"),a.ontrack=A,a.onicecandidate=r=>{r.candidate&&e.child("calleeCandidates").push(r.candidate.toJSON())},await a.setRemoteDescription(new RTCSessionDescription(n));const i=await a.createAnswer();await a.setLocalDescription(i),console.log("[RECONN-DEBUG] Joiner setting answer in Firebase:",{type:i.type,sdp:i.sdp}),await e.child("answer").set({type:i.type,sdp:i.sdp}),console.log("[RECONN-DEBUG] Joiner set answer in Firebase.");const o=await e.child("answer").once("value");console.log("[RECONN-DEBUG] Joiner read-back answer from Firebase:",o.val()),e.child("callerCandidates").on("child_added",r=>{const s=r.val();a&&a.addIceCandidate(new RTCIceCandidate(s))}),await O(c,"joiner","connected")})}}async function Ke(){if(console.log("🔄 handleReconnection started, isInitiator:",h,"roomId:",c),!c){console.error("No roomId found for reconnection"),p("Error: No room ID found for reconnection.");return}const e=h?"initiator":"joiner";p("Reconnecting..."),await O(c,e,"reconnecting"),await new Promise(n=>setTimeout(n,1e3));const t=g.ref(`rooms/${c}`);h?(await t.child("answer").remove(),await t.child("calleeCandidates").remove()):await t.child("callerCandidates").remove(),h&&await ue()}async function ue(){a=new RTCPeerConnection(j),y.getTracks().forEach(i=>{a.addTrack(i,y)}),console.log("[DEBUG] Assigning peerConnection.ontrack in createNewOffer"),a.ontrack=A;const e=g.ref(`rooms/${c}`);a.onicecandidate=i=>{i.candidate&&e.child("callerCandidates").push(i.candidate.toJSON())};const t=await a.createOffer();await a.setLocalDescription(t),await e.child("offer").set(t),console.log("[RECONN-DEBUG] Initiator attaching answer listener at path:",e.child("answer").toString()),e.child("answer").on("value",async i=>{const o=i.val();console.log("[RECONN-DEBUG] Initiator received answer snapshot:",o),o&&!a.currentRemoteDescription&&(await a.setRemoteDescription(new RTCSessionDescription(o)),console.log("[RECONN-DEBUG] Initiator set remote description with answer."))});const n=await e.child("answer").once("value");console.log("[RECONN-DEBUG] Initiator immediate read-back answer from Firebase:",n.val()),setTimeout(async()=>{const i=await e.child("answer").once("value");console.log("[RECONN-DEBUG] Initiator delayed (2s) read-back answer from Firebase:",i.val())},2e3),e.child("calleeCandidates").on("child_added",i=>{const o=i.val();a.addIceCandidate(new RTCIceCandidate(o))}),await O(c,"initiator","connected"),Q(c,"initiator",te),p("Reconnected! Waiting for partner...")}async function Xe(){h=!0,c||(c=et()),a=new RTCPeerConnection(j),y.getTracks().forEach(o=>{a.addTrack(o,y)});const e=await a.createOffer();await a.setLocalDescription(e);const t=await Le(c,e);console.log("[DEBUG] Assigning peerConnection.ontrack in initiateChatRoom"),a.ontrack=A,a.onicecandidate=o=>{o.candidate&&t.child("callerCandidates").push(o.candidate.toJSON())},t.child("answer").on("value",async o=>{const r=o.val();r&&!a.currentRemoteDescription&&await a.setRemoteDescription(new RTCSessionDescription(r))}),t.child("calleeCandidates").on("child_added",o=>{const r=o.val();a.addIceCandidate(new RTCIceCandidate(r))});const n=`${window.location.origin}${window.location.pathname}?room=${c}`;M.value=n,ae.style.display="block",S.disabled=!0,U.disabled=!1,ge(),B.style.display="block";const i="initiator";O(c,i,"connected"),Q(c,i,te),R(),p("Link ready! Waiting for partner...")}async function Qe(e){const{roomRef:t,roomSnapshot:n}=await xe(e);if(!n.exists()){p("Error: Invalid room link");return}a=new RTCPeerConnection(j),y.getTracks().forEach(s=>{a.addTrack(s,y)}),console.log("[DEBUG] Assigning peerConnection.ontrack in joinChatRoom"),a.ontrack=A,a.onicecandidate=s=>{s.candidate&&t.child("calleeCandidates").push(s.candidate.toJSON())};const i=n.val().offer;await a.setRemoteDescription(new RTCSessionDescription(i));const o=await a.createAnswer();await a.setLocalDescription(o),await t.child("answer").set({type:o.type,sdp:o.sdp}),t.child("callerCandidates").on("child_added",s=>{const m=s.val();a.addIceCandidate(new RTCIceCandidate(m))}),ge(),B.style.display="block",U.disabled=!1;const r="joiner";O(e,r,"connected"),Q(e,r,te),R()}async function Ze(){_e(x),fe(),a&&(a.close(),a=null),l.srcObject&&(l.srcObject.getTracks().forEach(e=>e.stop()),l.srcObject=null),c&&h&&await Be(c),c=null,h=!1,S.disabled=!1,S.style.display="block",U.disabled=!0,ae.style.display="none",N.style.display="none",F.style.display="none",B.style.display="none",re.style.display="none",ce.style.display="flex",M.value="",d.src="",P.value="",f.textContent="",T=!1,E=!1,k=!0,D=!1,window.history.replaceState({},document.title,window.location.pathname),J(),p("Disconnected. Ready for new chat.")}function et(){return Math.random().toString(36).substring(2,15)}function fe(){if(!c)return;const e=g.ref(`rooms/${c}`);e.child("answer").off(),e.child("offer").off(),e.child("callerCandidates").off(),e.child("calleeCandidates").off()}async function tt(){try{await navigator.clipboard.writeText(M.value),H.textContent="Copied!",setTimeout(()=>H.textContent="Copy Link",2e3)}catch{M.select(),document.execCommand("copy")}}function p(e){Oe(Ee,e)}function q(){E=Ne(y,N,E),R()}function Y(){k=Fe(y,F,k),R()}function W(){T=Me(T,ce,re,B,d,P,f),R()}function nt(){const e=P.value.trim();if(!e){f.textContent="Please enter a stream URL";return}if(V(e)){const t=se(e);le(t,d,me),f.textContent="YouTube video sent to partner..."}else de(d),d.src=e,f.textContent="Video sent to partner...";c&&g.ref(`rooms/${c}/stream`).set({url:e}),R()}function me(e){const t=z(),n=K();!c||!n||!t||(e.data===YT.PlayerState.PLAYING?g.ref(`rooms/${c}/stream`).update({playing:!0,time:t.getCurrentTime()}):e.data===YT.PlayerState.PAUSED&&g.ref(`rooms/${c}/stream`).update({playing:!1,time:t.getCurrentTime()}))}function ot(){const e=P.value;if(V(e)){const t=se(e);le(t,d,me),f.textContent="Loading YouTube video..."}else de(d),d.src=e,f.textContent="Loading shared video...";f.style.background="#2a2a2a"}function ge(){if(!c)return;const e=g.ref(`rooms/${c}`);e.child("stream/url").on("value",t=>{const n=t.val();n&&n!==P.value&&(P.value=n,f.innerHTML='Partner shared a video: <button id="accept-shared-video" style="margin-left: 10px; padding: 5px 15px;">✓ Accept & Load</button>',document.getElementById("accept-shared-video").addEventListener("click",ot),f.style.background="#2196f3")}),e.child("stream/playing").on("value",async t=>{if(w)return;const n=t.val(),i=P.value,o=z(),r=K();if(V(i)&&o&&r)n===!0&&o.getPlayerState()!==YT.PlayerState.PLAYING?(o.playVideo(),f.textContent="Playing in sync"):n===!1&&o.getPlayerState()===YT.PlayerState.PLAYING&&(o.pauseVideo(),f.textContent="Partner pressed pause");else if(n===!0&&d.paused)try{await d.play(),f.textContent="Playing in sync"}catch{f.textContent="▶️ Tap the video to start playing",f.style.background="#FF5722",f.style.fontSize="16px";const m=()=>{f.style.background="#2a2a2a",f.style.fontSize="14px",d.removeEventListener("play",m)};d.addEventListener("play",m)}else n===!1&&!d.paused&&(d.pause(),f.textContent="Partner pressed pause")}),e.child("stream/time").on("value",t=>{if(w)return;const n=t.val(),i=P.value,o=z(),r=K();V(i)&&o&&r?n!==null&&Math.abs(o.getCurrentTime()-n)>2&&(o.seekTo(n,!0),f.textContent=`Syncing to ${Math.floor(n)}s`):n!==null&&Math.abs(d.currentTime-n)>2&&(d.currentTime=n,f.textContent=`Syncing to ${Math.floor(n)}s`)}),d.addEventListener("play",()=>{c&&!w&&(w=!0,g.ref(`rooms/${c}/stream`).update({playing:!0,time:d.currentTime}),setTimeout(()=>w=!1,1e3))}),d.addEventListener("pause",()=>{c&&!w&&(w=!0,g.ref(`rooms/${c}/stream`).update({playing:!1,time:d.currentTime}),setTimeout(()=>w=!1,1e3))}),d.addEventListener("seeked",()=>{c&&!w&&(w=!0,g.ref(`rooms/${c}/stream`).update({time:d.currentTime}),setTimeout(()=>w=!1,1e3))}),d.addEventListener("loadeddata",()=>{f.textContent="Video loaded! Press play to start."}),d.addEventListener("waiting",()=>{f.textContent="Buffering..."}),d.addEventListener("playing",()=>{f.textContent="Playing in sync"})}ke.addEventListener("click",()=>{l.requestFullscreen?l.requestFullscreen():l.webkitRequestFullscreen?l.webkitRequestFullscreen():l.msRequestFullscreen&&l.msRequestFullscreen()});Te.addEventListener("click",()=>{v.requestFullscreen?v.requestFullscreen():v.webkitRequestFullscreen?v.webkitRequestFullscreen():v.msRequestFullscreen&&v.msRequestFullscreen()});ie.addEventListener("click",()=>{const e=v.srcObject?.getAudioTracks()[0];if(e){e.enabled=!e.enabled;const t=ie.querySelector("i");t&&(t.className=e.enabled?"fa fa-volume-mute":"fa fa-volume-up")}});oe.addEventListener("click",()=>{const e=l.srcObject?.getAudioTracks()[0];if(e){e.enabled=!e.enabled;const t=oe.querySelector("i");t&&(t.className=e.enabled?"fa fa-volume-mute":"fa fa-volume-up")}});ze();
