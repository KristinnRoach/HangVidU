(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();let a=null,v=!1;async function A(e,t,n){console.log("[PiP] Toggle requested",{hasDocumentPiP:"documentPictureInPicture"in window,hasStream:!!e.srcObject,pipWindowOpen:!!a,nativePipActive:v});try{if(!e.srcObject){console.warn("[PiP] No remote stream available"),n("Connect to a partner first");return}if(a){console.log("[PiP] Closing existing Document PiP window"),a.close(),a=null,t.textContent="Float Partner Video";return}"documentPictureInPicture"in window?await z(e,t):await G(e,t)}catch(i){console.error("[PiP] Error:",i.name,i.message,i),i.name==="NotAllowedError"?n("Picture-in-Picture blocked. Check browser permissions."):i.name==="InvalidStateError"?n("Cannot open PiP - video not ready"):n("Picture-in-Picture failed. See console for details.")}}async function z(e,t){console.log("[PiP] Opening Document PiP window");try{if(a=await window.documentPictureInPicture.requestWindow({width:400,height:300}),console.log("[PiP] Document PiP window created",{width:a.innerWidth,height:a.innerHeight,closed:a.closed}),a.closed)throw console.error("[PiP] Window was closed immediately after creation"),a=null,new Error("PiP window closed immediately");[...document.styleSheets].forEach(x=>{try{const j=[...x.cssRules].map(q=>q.cssText).join(""),w=document.createElement("style");w.textContent=j,a.document.head.appendChild(w)}catch{const w=document.createElement("link");w.rel="stylesheet",w.href=x.href,a.document.head.appendChild(w)}}),a.document.body.innerHTML=`
    <div style="display: flex; flex-direction: column; height: 100vh; background: #1a1a1a;">
      <video id="pipVideo" autoplay muted playsinline style="flex: 1; width: 100%; background: #000;"></video>
      <button id="pipMute" style="padding: 10px; background: #ff9800; color: white; border: none; cursor: pointer; font-size: 14px;">
        Unmute Partner
      </button>
    </div>
  `;const n=a.document.getElementById("pipVideo"),i=a.document.getElementById("pipMute"),o=e.srcObject.getVideoTracks(),r=e.srcObject.getAudioTracks();console.log("[PiP] Stream tracks:",{video:o.length,audio:r.length,videoActive:o[0]?.enabled,audioActive:r[0]?.enabled}),n.srcObject=e.srcObject,console.log("[PiP] Stream attached to PiP video"),console.log("[PiP] Video will autoplay (muted initially for browser policy)");let u=!0;i.addEventListener("click",()=>{if(!e.srcObject){console.warn("[PiP] Remote stream no longer available");return}u=!u,n.muted=u,i.textContent=u?"Unmute Partner":"Mute Partner",i.style.background=u?"#ff9800":"#4caf50",console.log("[PiP] Partner audio in PiP window:",u?"MUTED":"UNMUTED")}),a.addEventListener("pagehide",()=>{console.log("[PiP] Document PiP window closed by user or browser"),a=null,t.textContent="Float Partner Video"}),a.addEventListener("load",()=>{console.log("[PiP] Document PiP window loaded event fired")}),n.addEventListener("error",x=>{console.error("[PiP] Video element error:",x)}),n.addEventListener("loadedmetadata",()=>{console.log("[PiP] Video metadata loaded in PiP window")}),t.textContent="Close Float Window",console.log("[PiP] Document PiP setup complete")}catch(n){throw console.error("[PiP] Error during Document PiP setup:",n),a&&(a.close(),a=null),n}}async function G(e,t){document.pictureInPictureElement?(console.log("[PiP] Exiting native PiP"),await document.exitPictureInPicture(),v=!1,t.textContent="Float Partner Video"):(console.log("[PiP] Entering native PiP"),await e.requestPictureInPicture(),v=!0,t.textContent="Exit Float Mode")}function U(e,t){console.log("[PiP] Setting up native PiP event listeners for remote video"),e.addEventListener("enterpictureinpicture",()=>{console.log("[PiP] Remote video entered native PiP (via browser controls)"),v=!0,t.textContent="Exit Float Mode"}),e.addEventListener("leavepictureinpicture",()=>{console.log("[PiP] Remote video exited native PiP (via browser controls)"),v=!1,t.textContent="Float Partner Video"})}function H(e,t){console.log("[PiP] Setting up native PiP event listeners for local video (currently disabled)"),e.addEventListener("enterpictureinpicture",()=>{console.log("[PiP] Local video entered native PiP"),v=!1,t.textContent="Float Partner Video"}),e.addEventListener("leavepictureinpicture",()=>{console.log("[PiP] Local video exited native PiP")})}function K(e){console.log("[PiP] Cleanup requested"),a&&(console.log("[PiP] Closing Document PiP window during cleanup"),a.close(),a=null),v&&document.pictureInPictureElement&&(console.log("[PiP] Exiting native PiP during cleanup"),document.exitPictureInPicture().catch(t=>{console.warn("[PiP] Failed to exit native PiP:",t)}),v=!1),e&&(e.textContent="Float Partner Video",e.style.display="none"),console.log("[PiP] Cleanup complete")}const _={apiKey:"AIzaSyA-fvCaKCjyEFX__YAVr1oPGdVsUEhFehA",authDomain:"vidu-aae11.firebaseapp.com",databaseURL:"https://vidu-aae11-default-rtdb.europe-west1.firebasedatabase.app",projectId:"vidu-aae11",storageBucket:"vidu-aae11.firebasestorage.app",messagingSenderId:"765724787439",appId:"1:765724787439:web:61a3b5dd538149564c911a",measurementId:"G-EGJ53HLGY4"};firebase.initializeApp(_);const g=firebase.database();firebase.storage();let f,c,l=null,R=!1,b=!1,C=!0;const F={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},M=document.getElementById("localVideo"),p=document.getElementById("remoteVideo"),E=document.getElementById("startChat"),T=document.getElementById("hangUp"),J=document.getElementById("status"),$=document.getElementById("linkContainer"),I=document.getElementById("shareLink"),B=document.getElementById("copyLink"),y=document.getElementById("pipBtn"),S=document.getElementById("toggleMute"),O=document.getElementById("toggleVideo"),h=document.getElementById("toggleMode"),V=document.getElementById("watchContainer"),D=document.querySelector(".video-container"),k=document.getElementById("streamUrl"),Y=document.getElementById("loadStream"),s=document.getElementById("sharedVideo"),d=document.getElementById("syncStatus");document.getElementById("videoFile");document.getElementById("uploadProgress");let L=!1,m=!1;async function X(){try{f=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),M.srcObject=f,M.srcObject=f,S.style.display="block",O.style.display="block",H(M,y),N(),l=new URLSearchParams(window.location.search).get("room"),l?(P("Connecting..."),E.style.display="none",await Z(l)):P("Ready. Click to generate video chat link.")}catch(e){console.error("Media error:",e),P("Error: Could not access camera/mic. Check permissions.")}}async function Q(){R=!0,l=te();const e=g.ref(`rooms/${l}`);c=new RTCPeerConnection(F),f.getTracks().forEach(i=>{c.addTrack(i,f)}),c.ontrack=i=>{p.srcObject=i.streams[0],y.style.display="block",U(p,y),P("Connected!")},c.onicecandidate=i=>{i.candidate&&e.child("callerCandidates").push(i.candidate.toJSON())};const t=await c.createOffer();await c.setLocalDescription(t),await e.set({offer:{type:t.type,sdp:t.sdp}}),e.child("answer").on("value",async i=>{const o=i.val();o&&!c.currentRemoteDescription&&await c.setRemoteDescription(new RTCSessionDescription(o))}),e.child("calleeCandidates").on("child_added",i=>{const o=i.val();c.addIceCandidate(new RTCIceCandidate(o))});const n=`${window.location.origin}${window.location.pathname}?room=${l}`;I.value=n,$.style.display="block",E.disabled=!0,T.disabled=!1,W(),h.style.display="block",P("Link ready! Waiting for partner...")}async function Z(e){const t=g.ref(`rooms/${e}`),n=await t.once("value");if(!n.exists()){P("Error: Invalid room link");return}c=new RTCPeerConnection(F),f.getTracks().forEach(r=>{c.addTrack(r,f)}),c.ontrack=r=>{p.srcObject=r.streams[0],y.style.display="block",U(p,y),P("Connected!")},c.onicecandidate=r=>{r.candidate&&t.child("calleeCandidates").push(r.candidate.toJSON())};const i=n.val().offer;await c.setRemoteDescription(new RTCSessionDescription(i));const o=await c.createAnswer();await c.setLocalDescription(o),await t.child("answer").set({type:o.type,sdp:o.sdp}),t.child("callerCandidates").on("child_added",r=>{const u=r.val();c.addIceCandidate(new RTCIceCandidate(u))}),W(),h.style.display="block",T.disabled=!1}async function ee(){K(y),c&&(c.close(),c=null),p.srcObject&&(p.srcObject.getTracks().forEach(e=>e.stop()),p.srcObject=null),l&&R&&await g.ref(`rooms/${l}`).remove(),l=null,R=!1,E.disabled=!1,E.style.display="block",T.disabled=!0,$.style.display="none",S.style.display="none",O.style.display="none",h.style.display="none",V.style.display="none",D.style.display="flex",I.value="",s.src="",k.value="",d.textContent="",L=!1,b=!1,C=!0,window.history.replaceState({},document.title,window.location.pathname),P("Disconnected. Ready for new chat.")}function te(){return Math.random().toString(36).substring(2,15)}async function ne(){try{await navigator.clipboard.writeText(I.value),B.textContent="Copied!",setTimeout(()=>B.textContent="Copy Link",2e3)}catch{I.select(),document.execCommand("copy")}}y.addEventListener("click",async()=>{await A(p,y,P)});function P(e){J.textContent=e}function N(){const e=f.getAudioTracks()[0];e&&(b=!b,e.enabled=!b,S.textContent=b?"Unmute Audio":"Mute Audio")}function oe(){const e=f.getVideoTracks()[0];e&&(C=!C,e.enabled=C,O.textContent=C?"Turn Video Off":"Turn Video On")}function ie(){L=!L,L?(D.style.display="none",V.style.display="block",h.textContent="Switch to Video Chat",d.textContent="Paste the same stream URL as your partner"):(D.style.display="flex",V.style.display="none",h.textContent="Switch to Watch Mode",s.src="",k.value="")}function ae(){const e=k.value.trim();if(!e){d.textContent="Please enter a stream URL";return}s.src=e,d.textContent="Video sent to partner...",l&&g.ref(`rooms/${l}/stream`).set({url:e})}function W(){if(!l)return;const e=g.ref(`rooms/${l}`);e.child("stream/url").on("value",t=>{const n=t.val();n&&n!==k.value&&n!==s.src&&(k.value=n,d.innerHTML=`
      Partner shared a video: 
      <button onclick="acceptSharedVideo()" style="margin-left: 10px; padding: 5px 15px;">
        ✓ Accept & Load
      </button>
    `,d.style.background="#2196f3")}),e.child("stream/playing").on("value",async t=>{if(m)return;const n=t.val();if(n===!0&&s.paused)try{await s.play(),d.textContent="Playing in sync"}catch{d.textContent="▶️ Tap the video to start playing",d.style.background="#FF5722",d.style.fontSize="16px";const o=()=>{d.style.background="#2a2a2a",d.style.fontSize="14px",s.removeEventListener("play",o)};s.addEventListener("play",o)}else n===!1&&!s.paused&&(s.pause(),d.textContent="Partner pressed pause")}),e.child("stream/time").on("value",t=>{if(m)return;const n=t.val();n!==null&&Math.abs(s.currentTime-n)>2&&(s.currentTime=n,d.textContent=`Syncing to ${Math.floor(n)}s`)}),s.addEventListener("play",()=>{l&&!m&&(m=!0,g.ref(`rooms/${l}/stream`).update({playing:!0,time:s.currentTime}),setTimeout(()=>m=!1,1e3))}),s.addEventListener("pause",()=>{l&&!m&&(m=!0,g.ref(`rooms/${l}/stream`).update({playing:!1,time:s.currentTime}),setTimeout(()=>m=!1,1e3))}),s.addEventListener("seeked",()=>{l&&!m&&(m=!0,g.ref(`rooms/${l}/stream`).update({time:s.currentTime}),setTimeout(()=>m=!1,1e3))}),s.addEventListener("loadeddata",()=>{d.textContent="Video loaded! Press play to start."}),s.addEventListener("waiting",()=>{d.textContent="Buffering..."}),s.addEventListener("playing",()=>{d.textContent="Playing in sync"})}document.addEventListener("keydown",e=>{e.altKey&&e.key==="p"&&p.srcObject&&(e.preventDefault(),A(p,y,P))});E.addEventListener("click",Q);T.addEventListener("click",ee);B.addEventListener("click",ne);S.addEventListener("click",N);O.addEventListener("click",oe);h.addEventListener("click",ie);Y.addEventListener("click",ae);X();
