(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const R=document.getElementById("localVideo"),f=document.getElementById("remoteVideo"),s=document.getElementById("sharedVideo"),x=document.getElementById("startChat"),I=document.getElementById("hangUp"),O=document.getElementById("copyLink"),g=document.getElementById("pipBtn"),S=document.getElementById("toggleMute"),M=document.getElementById("toggleVideo"),C=document.getElementById("toggleMode"),K=document.getElementById("loadStream"),_=document.getElementById("status"),$=document.getElementById("linkContainer"),B=document.getElementById("watchContainer"),D=document.querySelector(".video-container"),l=document.getElementById("syncStatus"),T=document.getElementById("shareLink"),w=document.getElementById("streamUrl");let r=null,v=!1;async function W(e,t,o){console.log("[PiP] Toggle requested",{hasDocumentPiP:"documentPictureInPicture"in window,hasStream:!!e.srcObject,pipWindowOpen:!!r,nativePipActive:v});try{if(!e.srcObject){console.warn("[PiP] No remote stream available"),o("Connect to a partner first");return}if(r){console.log("[PiP] Closing existing Document PiP window"),r.close(),r=null,t.textContent="Float Partner Video";return}"documentPictureInPicture"in window?await J(e,t):await X(e,t)}catch(i){console.error("[PiP] Error:",i.name,i.message,i),i.name==="NotAllowedError"?o("Picture-in-Picture blocked. Check browser permissions."):i.name==="InvalidStateError"?o("Cannot open PiP - video not ready"):o("Picture-in-Picture failed. See console for details.")}}async function J(e,t){console.log("[PiP] Opening Document PiP window");try{if(r=await window.documentPictureInPicture.requestWindow({width:400,height:300}),console.log("[PiP] Document PiP window created",{width:r.innerWidth,height:r.innerHeight,closed:r.closed}),r.closed)throw console.error("[PiP] Window was closed immediately after creation"),r=null,new Error("PiP window closed immediately");[...document.styleSheets].forEach(h=>{try{const N=[...h.cssRules].map(H=>H.cssText).join(""),b=document.createElement("style");b.textContent=N,r.document.head.appendChild(b)}catch{const b=document.createElement("link");b.rel="stylesheet",b.href=h.href,r.document.head.appendChild(b)}}),r.document.body.innerHTML=`
    <div style="display: flex; flex-direction: column; height: 100vh; background: #1a1a1a;">
      <video id="pipVideo" autoplay muted playsinline style="flex: 1; width: 100%; background: #000;"></video>
      <button id="pipMute" style="padding: 10px; background: #ff9800; color: white; border: none; cursor: pointer; font-size: 14px;">
        Unmute Partner
      </button>
    </div>
  `;const o=r.document.getElementById("pipVideo"),i=r.document.getElementById("pipMute"),n=e.srcObject.getVideoTracks(),a=e.srcObject.getAudioTracks();console.log("[PiP] Stream tracks:",{video:n.length,audio:a.length,videoActive:n[0]?.enabled,audioActive:a[0]?.enabled}),o.srcObject=e.srcObject,console.log("[PiP] Stream attached to PiP video"),console.log("[PiP] Video will autoplay (muted initially for browser policy)");let u=!0;i.addEventListener("click",()=>{if(!e.srcObject){console.warn("[PiP] Remote stream no longer available");return}u=!u,o.muted=u,i.textContent=u?"Unmute Partner":"Mute Partner",i.style.background=u?"#ff9800":"#4caf50",console.log("[PiP] Partner audio in PiP window:",u?"MUTED":"UNMUTED")}),r.addEventListener("pagehide",()=>{console.log("[PiP] Document PiP window closed by user or browser"),r=null,t.textContent="Float Partner Video"}),r.addEventListener("load",()=>{console.log("[PiP] Document PiP window loaded event fired")}),o.addEventListener("error",h=>{console.error("[PiP] Video element error:",h)}),o.addEventListener("loadedmetadata",()=>{console.log("[PiP] Video metadata loaded in PiP window")}),t.textContent="Close Float Window",console.log("[PiP] Document PiP setup complete")}catch(o){throw console.error("[PiP] Error during Document PiP setup:",o),r&&(r.close(),r=null),o}}async function X(e,t){document.pictureInPictureElement?(console.log("[PiP] Exiting native PiP"),await document.exitPictureInPicture(),v=!1,t.textContent="Float Partner Video"):(console.log("[PiP] Entering native PiP"),await e.requestPictureInPicture(),v=!0,t.textContent="Exit Float Mode")}function G(e,t){console.log("[PiP] Setting up native PiP event listeners for remote video"),e.addEventListener("enterpictureinpicture",()=>{console.log("[PiP] Remote video entered native PiP (via browser controls)"),v=!0,t.textContent="Exit Float Mode"}),e.addEventListener("leavepictureinpicture",()=>{console.log("[PiP] Remote video exited native PiP (via browser controls)"),v=!1,t.textContent="Float Partner Video"})}function Q(e,t){console.log("[PiP] Setting up native PiP event listeners for local video (currently disabled)"),e.addEventListener("enterpictureinpicture",()=>{console.log("[PiP] Local video entered native PiP"),v=!1,t.textContent="Float Partner Video"}),e.addEventListener("leavepictureinpicture",()=>{console.log("[PiP] Local video exited native PiP")})}function Z(e){console.log("[PiP] Cleanup requested"),r&&(console.log("[PiP] Closing Document PiP window during cleanup"),r.close(),r=null),v&&document.pictureInPictureElement&&(console.log("[PiP] Exiting native PiP during cleanup"),document.exitPictureInPicture().catch(t=>{console.warn("[PiP] Failed to exit native PiP:",t)}),v=!1),e&&(e.textContent="Float Partner Video",e.style.display="none"),console.log("[PiP] Cleanup complete")}let Y=null,F=!1;function V(e){return/(?:youtu.be\/|youtube.com\/(?:watch\?v=|embed\/|v\/))([\w-]{11})/.test(e)}function ee(e){const t=e.match(/(?:youtu.be\/|youtube.com\/(?:watch\?v=|embed\/|v\/))([\w-]{11})/);return t?t[1]:null}function te(e,t,o){t.style.display="none";const i=document.getElementById("yt-iframe");i&&i.remove();let n=document.getElementById("yt-player-div");n||(n=document.createElement("div"),n.id="yt-player-div",t.parentNode.insertBefore(n,t)),n.innerHTML='<div id="yt-iframe"></div>',n.style.display="",Y=new YT.Player("yt-iframe",{height:"360",width:"640",videoId:e,events:{onReady:()=>{F=!0},onStateChange:o}})}function ne(e){const t=document.getElementById("yt-player-div");t&&(t.style.display="none"),e.style.display="",Y=null,F=!1}function A(){return Y}function j(){return F}const oe={apiKey:"AIzaSyA-fvCaKCjyEFX__YAVr1oPGdVsUEhFehA",authDomain:"vidu-aae11.firebaseapp.com",databaseURL:"https://vidu-aae11-default-rtdb.europe-west1.firebasedatabase.app",projectId:"vidu-aae11",storageBucket:"vidu-aae11.firebasestorage.app",messagingSenderId:"765724787439",appId:"1:765724787439:web:61a3b5dd538149564c911a",measurementId:"G-EGJ53HLGY4"};firebase.initializeApp(oe);const m=firebase.database(),q={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};let P,d,c=null,U=!1,E=!1,k=!0,L=!1,y=!1;async function ie(){try{P=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),R.srcObject=P,R.srcObject=P,S.style.display="block",M.style.display="block",Q(R,g),c=new URLSearchParams(window.location.search).get("room"),c?(p("Connecting..."),x.style.display="none",await re(c)):p("Ready. Click to generate video chat link.")}catch(e){console.error("Media error:",e),p("Error: Could not access camera/mic. Check permissions.")}}async function ae(){U=!0,c=ce();const e=m.ref(`rooms/${c}`);d=new RTCPeerConnection(q),P.getTracks().forEach(i=>{d.addTrack(i,P)}),d.ontrack=i=>{f.srcObject=i.streams[0],g.style.display="block",G(f,g),p("Connected!")},d.onicecandidate=i=>{i.candidate&&e.child("callerCandidates").push(i.candidate.toJSON())};const t=await d.createOffer();await d.setLocalDescription(t),await e.set({offer:{type:t.type,sdp:t.sdp}}),e.child("answer").on("value",async i=>{const n=i.val();n&&!d.currentRemoteDescription&&await d.setRemoteDescription(new RTCSessionDescription(n))}),e.child("calleeCandidates").on("child_added",i=>{const n=i.val();d.addIceCandidate(new RTCIceCandidate(n))});const o=`${window.location.origin}${window.location.pathname}?room=${c}`;T.value=o,$.style.display="block",x.disabled=!0,I.disabled=!1,z(),C.style.display="block",p("Link ready! Waiting for partner...")}async function re(e){const t=m.ref(`rooms/${e}`),o=await t.once("value");if(!o.exists()){p("Error: Invalid room link");return}d=new RTCPeerConnection(q),P.getTracks().forEach(a=>{d.addTrack(a,P)}),d.ontrack=a=>{f.srcObject=a.streams[0],g.style.display="block",G(f,g),p("Connected!")},d.onicecandidate=a=>{a.candidate&&t.child("calleeCandidates").push(a.candidate.toJSON())};const i=o.val().offer;await d.setRemoteDescription(new RTCSessionDescription(i));const n=await d.createAnswer();await d.setLocalDescription(n),await t.child("answer").set({type:n.type,sdp:n.sdp}),t.child("callerCandidates").on("child_added",a=>{const u=a.val();d.addIceCandidate(new RTCIceCandidate(u))}),z(),C.style.display="block",I.disabled=!1}async function se(){Z(g),d&&(d.close(),d=null),f.srcObject&&(f.srcObject.getTracks().forEach(e=>e.stop()),f.srcObject=null),c&&U&&await m.ref(`rooms/${c}`).remove(),c=null,U=!1,x.disabled=!1,x.style.display="block",I.disabled=!0,$.style.display="none",S.style.display="none",M.style.display="none",C.style.display="none",B.style.display="none",D.style.display="flex",T.value="",s.src="",w.value="",l.textContent="",L=!1,E=!1,k=!0,window.history.replaceState({},document.title,window.location.pathname),p("Disconnected. Ready for new chat.")}function ce(){return Math.random().toString(36).substring(2,15)}async function le(){try{await navigator.clipboard.writeText(T.value),O.textContent="Copied!",setTimeout(()=>O.textContent="Copy Link",2e3)}catch{T.select(),document.execCommand("copy")}}g.addEventListener("click",async()=>{await W(f,g,p)});function p(e){_.textContent=e}function de(){const e=P.getAudioTracks()[0];e&&(E=!E,e.enabled=!E,S.textContent=E?"Unmute Mic":"Mute Mic")}function ue(){const e=P.getVideoTracks()[0];e&&(k=!k,e.enabled=k,M.textContent=k?"Turn Video Off":"Turn Video On")}function ye(){L=!L,L?(D.style.display="none",B.style.display="block",C.textContent="Switch to Video Chat",l.textContent="Paste the same stream URL as your partner"):(D.style.display="flex",B.style.display="none",C.textContent="Switch to Watch Mode",s.src="",w.value="")}function me(){const e=w.value.trim();if(!e){l.textContent="Please enter a stream URL";return}if(V(e)){const t=ee(e);te(t,s,fe),l.textContent="YouTube video sent to partner..."}else ne(s),s.src=e,l.textContent="Video sent to partner...";c&&m.ref(`rooms/${c}/stream`).set({url:e})}function fe(e){const t=A(),o=j();!c||!o||!t||(e.data===YT.PlayerState.PLAYING?m.ref(`rooms/${c}/stream`).update({playing:!0,time:t.getCurrentTime()}):e.data===YT.PlayerState.PAUSED&&m.ref(`rooms/${c}/stream`).update({playing:!1,time:t.getCurrentTime()}))}function z(){if(!c)return;const e=m.ref(`rooms/${c}`);e.child("stream/url").on("value",t=>{const o=t.val();o&&o!==w.value&&(w.value=o,l.innerHTML='Partner shared a video: <button onclick="acceptSharedVideo()" style="margin-left: 10px; padding: 5px 15px;">✓ Accept & Load</button>',l.style.background="#2196f3")}),e.child("stream/playing").on("value",async t=>{if(y)return;const o=t.val(),i=w.value,n=A(),a=j();if(V(i)&&n&&a)o===!0&&n.getPlayerState()!==YT.PlayerState.PLAYING?(n.playVideo(),l.textContent="Playing in sync"):o===!1&&n.getPlayerState()===YT.PlayerState.PLAYING&&(n.pauseVideo(),l.textContent="Partner pressed pause");else if(o===!0&&s.paused)try{await s.play(),l.textContent="Playing in sync"}catch{l.textContent="▶️ Tap the video to start playing",l.style.background="#FF5722",l.style.fontSize="16px";const h=()=>{l.style.background="#2a2a2a",l.style.fontSize="14px",s.removeEventListener("play",h)};s.addEventListener("play",h)}else o===!1&&!s.paused&&(s.pause(),l.textContent="Partner pressed pause")}),e.child("stream/time").on("value",t=>{if(y)return;const o=t.val(),i=w.value,n=A(),a=j();V(i)&&n&&a?o!==null&&Math.abs(n.getCurrentTime()-o)>2&&(n.seekTo(o,!0),l.textContent=`Syncing to ${Math.floor(o)}s`):o!==null&&Math.abs(s.currentTime-o)>2&&(s.currentTime=o,l.textContent=`Syncing to ${Math.floor(o)}s`)}),s.addEventListener("play",()=>{c&&!y&&(y=!0,m.ref(`rooms/${c}/stream`).update({playing:!0,time:s.currentTime}),setTimeout(()=>y=!1,1e3))}),s.addEventListener("pause",()=>{c&&!y&&(y=!0,m.ref(`rooms/${c}/stream`).update({playing:!1,time:s.currentTime}),setTimeout(()=>y=!1,1e3))}),s.addEventListener("seeked",()=>{c&&!y&&(y=!0,m.ref(`rooms/${c}/stream`).update({time:s.currentTime}),setTimeout(()=>y=!1,1e3))}),s.addEventListener("loadeddata",()=>{l.textContent="Video loaded! Press play to start."}),s.addEventListener("waiting",()=>{l.textContent="Buffering..."}),s.addEventListener("playing",()=>{l.textContent="Playing in sync"})}document.addEventListener("keydown",e=>{e.altKey&&e.key==="p"&&f.srcObject&&(e.preventDefault(),W(f,g,p))});x.addEventListener("click",ae);I.addEventListener("click",se);O.addEventListener("click",le);S.addEventListener("click",de);M.addEventListener("click",ue);C.addEventListener("click",ye);K.addEventListener("click",me);ie();
